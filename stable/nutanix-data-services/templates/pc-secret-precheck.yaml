# Copyright 2024 Nutanix Inc

# Exit this validation if we're in dry-run mode
{{- $checkResource := lookup "v1" "Namespace" "" "ntnx-system" }}
{{- if eq (len ($checkResource)) 0 }}
    # DEBUG: Running in helm template mode (no cluster connection)
    {{- /* This indicates we're in dry-run mode and there is no API server connection */}}
    {{- /* Skip the pc-secret validation */}}
{{- else }}
    # Commands to be displayed along with errors to help users debug.  
    {{- $valuesSecretLoc := "'.Values.config.secret.name'" }}
    {{- $valuesSecretName := .Values.config.secret.name -}}
    {{- $releaseNS := .Release.Namespace -}}
    {{- $secretFormat := "'pc_ip:port:username:password'"}}

    # Error for ntnx-pc-secret not found in release namespace.
    {{- $ntnxPcSecretNotFoundErr := printf "%s%s%s%s%s%s%s%s%s%s%s%s%s"
    "Secret " $valuesSecretName " not found in " $releaseNS
    ". Please create a secret in " $releaseNS " with a key named 'key',"
    " and value that contains admin credentials in the format " $secretFormat
    ". Please supply the secret name for use by NDK in " $valuesSecretLoc
    ". Check list of secrets with - kubectl get secret -n " $releaseNS }}

    {{- $ntnxpcsecret := lookup "v1" "Secret" $releaseNS .Values.config.secret.name }}
    {{- if eq (len ($ntnxpcsecret)) 0 }}
        {{- fail $ntnxPcSecretNotFoundErr}}
    {{- end }}

    # Extract the secret data.
    {{- $ntnxpcsecretData := $ntnxpcsecret.data }}
    {{- $keyName := "key" }}
    {{- $keyValue := index $ntnxpcsecretData $keyName }}

    # Base64 decode the value, which will be of the form 'ip:port:username:password'
    # and extract the username.
    {{- $decodedKeyValue := b64dec $keyValue }}
    {{- $decodedKeyValueSplit := regexSplit ":" $decodedKeyValue 4 }}
    {{- if ne (len $decodedKeyValueSplit) 4 }}
        {{- fail (printf "Secret key 'key' must contain exactly 4 colon-separated values in format %s, got %d parts" $secretFormat (len $decodedKeyValueSplit)) }}
    {{- end }}
    {{- $username := index $decodedKeyValueSplit 2 }}
{{- end }}
