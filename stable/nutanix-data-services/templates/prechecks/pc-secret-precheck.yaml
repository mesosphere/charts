# Copyright 2024 Nutanix Inc

{{- define "precheck.pcSecret" -}}

  # Exit this validation if we're in dry-run mode
  {{- $checkResource := lookup "v1" "Namespace" "" "kube-system" }}
  {{- if eq (len ($checkResource)) 0 }}
      # DEBUG: Running in helm template mode (no cluster connection)
      {{- /* This indicates we're in dry-run mode and there is no API server connection */}}
      {{- /* Skip the pc-secret validation */}}
  {{- else }}

      {{- $valuesSecretName := .Values.config.secret.name -}}
      {{- $releaseNS := .Release.Namespace -}}
      {{- $enableServiceAuth := include "chart.enableServiceAuth" . | trim | eq "true" -}}

      # Examples to show in error
      {{- $exampleBasicAuth := `stringData:
      key: "<host>:<port>:<username>:<password>"` | nindent 2 }}

      {{- $expectedBasicAuthFormats := printf "\n\nExpected format:\n\nBasic Auth:\n%s" $exampleBasicAuth }}

      {{- $exampleServiceAuth := `stringData:
      host: "<host>"
      port: "<port>"
      auth_type: "service-auth"
      key_value: "<key_value>"
      key_type: "api-key"` | nindent 2 }}

      {{- $expectedServiceAuthFormats := printf "\n\nExpected format:\n\nService Auth:\n%s" $exampleServiceAuth }}
      
      {{- $expectedFormats := "" }}
      {{- if $enableServiceAuth }}
        {{- $expectedFormats = printf "\n\nExpected formats:\n\nService Auth:\n%s\n\nBasic Auth:\n%s" $exampleServiceAuth $exampleBasicAuth }}
      {{- else }}
        {{- $expectedFormats = $expectedBasicAuthFormats }}
      {{- end }}

      # Load secret
      {{- $secret := lookup "v1" "Secret" $releaseNS $valuesSecretName }}
      {{- if not $secret }}
        {{- fail (printf "Secret '%s' not found in namespace '%s'.%s" $valuesSecretName $releaseNS $expectedFormats) }}
      {{- end }}

      {{- $parsed := dict }}

      # Check for auth_type field to determine format
      {{- $authTypeData := index $secret.data "auth_type" }}
      
      {{- if and $authTypeData $enableServiceAuth }}
        # Individual fields format - only allowed for service-auth
        {{- $authType := b64dec $authTypeData }}
        {{- if eq $authType "service-auth" }}
          # Service-auth requires individual fields format
          {{- $hostData := index $secret.data "host" }}
          {{- $portData := index $secret.data "port" }}
          {{- $keyValueData := index $secret.data "key_value" }}
          
          {{- if not (and $hostData $portData $keyValueData) }}
            {{- fail (printf "Service authentication requires all fields: host, port, auth_type, key_value.%s" $expectedServiceAuthFormats) }}
          {{- end }}
          
          {{- $parsed = set $parsed "host" (b64dec $hostData) }}
          {{- $parsed = set $parsed "port" (b64dec $portData) }}
          {{- $parsed = set $parsed "auth_type" "service-auth" }}
          {{- $parsed = set $parsed "key_value" (b64dec $keyValueData) }}
          
        {{- else }}
          {{- fail (printf "Unsupported auth_type '%s'.%s" $authType $expectedFormats) }}
        {{- end }}
      {{- else }}
        # Key field format - only allowed for basic-auth
        {{- $keyData := index $secret.data "key" }}
        {{- if not $keyData }}
          {{- fail (printf "Secret '%s' is missing required fields.%s" $valuesSecretName $expectedFormats) }}
        {{- end }}

        # Decode and parse key field format: host:port:username:password
        {{- $decoded := b64dec $keyData }}
        {{- $parts := splitList ":" $decoded }}
        {{- if ne (len $parts) 4 }}
          {{- fail (printf "'key' field must be in format 'host:port:username:password', got %d parts.%s" (len $parts) $expectedBasicAuthFormats) }}
        {{- end }}

        {{- $parsed = set $parsed "host" (index $parts 0) }}
        {{- $parsed = set $parsed "port" (index $parts 1) }}
        {{- $parsed = set $parsed "username" (index $parts 2) }}
        {{- $parsed = set $parsed "password" (index $parts 3) }}
        {{- $parsed = set $parsed "auth_type" "basic-auth" }}
      {{- end }}

      # Get auth_type
      {{- $authType := $parsed.auth_type }}
      {{- if not $authType }}
        {{- fail (printf "'auth_type' not found in secret %s.%s" $valuesSecretName $expectedFormats) }}
      {{- end }}

      # Validate fields based on auth_type
      {{- if eq $authType "basic-auth" }}
        {{- if not $parsed.username }}
        {{- fail (printf "'basic-auth' requires 'username'.\n\n%s" $exampleBasicAuth) }}
        {{- end }}
        {{- if not $parsed.password }}
        {{- fail (printf "'basic-auth' requires 'password'.\n\n%s" $exampleBasicAuth) }}
        {{- end }}
      {{- else if eq $authType "service-auth" }}
        {{- if not $parsed.key_value }}
          {{- fail (printf "'service-auth' requires 'key_value'.\n\n%s" $exampleServiceAuth) }}
        {{- end }}
      {{- else }}
        {{- fail (printf "Unsupported auth_type '%s'. Supported: basic-auth, service-auth.%s" $authType $expectedFormats) }}
      {{- end }}
  {{- end }}
{{- end }}