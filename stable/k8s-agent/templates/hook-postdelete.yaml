apiVersion: v1
kind: ServiceAccount
metadata:
  name: nkp-k8s-agent-postdelete
  namespace: {{ (include "k8s-agent.namespace" .) | quote }}
  annotations:
    "helm.sh/hook": "post-delete"
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: nkp-k8s-agent-postdelete
  namespace: {{ (include "k8s-agent.namespace" .) | quote }}
  annotations:
    "helm.sh/hook": "post-delete"
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": hook-succeeded
rules:
- apiGroups:
  - '*'
  resources:
  - '*'
  verbs:
  - '*'
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: nkp-k8s-agent-postdelete
  namespace: {{ (include "k8s-agent.namespace" .) | quote }}
  annotations:
    "helm.sh/hook": "post-delete"
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": hook-succeeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: nkp-k8s-agent-postdelete
subjects:
- kind: ServiceAccount
  name: nkp-k8s-agent-postdelete
  namespace: {{ (include "k8s-agent.namespace" .) | quote }}
---
apiVersion: v1
kind: Pod
metadata:
  name: hook-postdelete
  namespace: {{ (include "k8s-agent.namespace" .) | quote }}
  annotations:
    "helm.sh/hook": "post-delete"
    "helm.sh/hook-weight": "2"
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
spec:
  {{- if eq .Values.agent.image.privateRegistry true}}
  imagePullSecrets:
  - name: nutanix-k8s-agent-pull-secret
  {{- end }}
  securityContext:
    runAsUser: 9999
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault
  serviceAccountName: nkp-k8s-agent-postdelete
  volumes:
  - name: pc-creds-volume
    secret:
      secretName: {{ .Values.agent.name }}  
  containers:
  - name: hook-postdelete-container
    image: "{{ .Values.agent.image.repository }}/{{ .Values.agent.image.name }}:{{ .Values.agent.image.tag | default .Chart.AppVersion }}"
    imagePullPolicy: {{ .Values.agent.image.pullPolicy }}
    command: ["/k8s-agent/k8s-agent"]
    volumeMounts:
      - name: pc-creds-volume
        mountPath: /certs
        readOnly: true
    args:
      [
        "--chart-hook=post-delete",
        "--pc-endpoint={{ required "Endpoint is required" .Values.pc.endpoint }}",
        "--pc-port={{ .Values.pc.port }}",
        "--insecure={{ .Values.pc.insecure }}",
        "--k8s-cluster-name={{ required "Name of kubernetes cluster is required" .Values.k8sClusterName }}",
        "--k8s-distribution={{ required "Kubernetes distribution is required" .Values.k8sDistribution }}",
        "--k8s-cluster-category={{ .Values.categoryMappings }}",
        "--update-config-in-min={{ .Values.agent.updateConfigInMin }}",
        "--update-metrics-in-min={{ .Values.agent.updateMetricsInMin }}",
      ]
    securityContext:
      runAsUser: 9999
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      seccompProfile:
        type: RuntimeDefault
      capabilities:
        drop:
          - ALL       
  restartPolicy: Never
  terminationGracePeriodSeconds: 0